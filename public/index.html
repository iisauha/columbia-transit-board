<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Columbia Transit Board</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        background: #000;
        color: #fff;
        font-family: "Courier New", monospace;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .board {
        width: 100%;
        height: 100%;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .panel {
        flex: 1;
        background: #050505;
        border-radius: 10px;
        border: 2px solid #222;
        padding: 10px 18px;
        display: flex;
        flex-direction: column;
      }
      .panel-title {
        font-size: 1.9rem;
        margin-bottom: 4px;
      }
      .panel-subtitle {
        font-size: 1.05rem;
        opacity: 0.8;
        margin-bottom: 6px;
      }
      .line {
        display: flex;
        justify-content: space-between;
        font-size: 1.5rem;
        margin-bottom: 2px;
      }
      .line-dest {
        max-width: 60%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .line-times {
        text-align: right;
        white-space: nowrap;
      }
      .pill {
        display: inline-block;
        min-width: 32px;
        padding: 2px 8px;
        border-radius: 999px;
        margin-left: 8px;
        font-size: 0.95rem;
      }
      .pill.green {
        background: #00a651;
      }
      .pill.red {
        background: #d32f2f;
      }
      .pill.blue {
        background: #1976d2;
      }
      .small {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 4px;
      }
      /* Subway bullet */
      .bullet {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        margin-right: 8px;
        font-size: 1rem;
        font-weight: bold;
        color: #fff;
      }
      .bullet.route-1 {
        background: #ee352e; /* MTA 1 line red */
      }
      .time-good {
        color: #00ff7f;
      }
      .time-delayed {
        color: #ff5252;
      }

      .removed-walk-icon {
        display: inline-block;
        width: 14px;
        height: 14px;
        margin: 0 4px;
        background-color: currentColor;
        -webkit-mask: url("walk.png") center/contain no-repeat;
        mask: url("walk.png") center/contain no-repeat;
      }
    </style>
  </head>
  <body>
    <div class="board">
      <!-- Subway -->
      <div class="panel">
        <div class="panel-title">125th Subway times</div>
        <div class="panel-subtitle">
          South Ferry &amp; Van Cortlandt bound · 1 train
        </div>
        <div id="subway-lines"></div>
        <div class="small" id="subway-updated"></div>
      </div>

      <!-- Intercampus Shuttle -->
      <div class="panel">
        <div class="panel-title">Columbia University Shuttles</div>
        <div class="panel-subtitle">
          La Salle/Tiemann Pl (EC S) &amp; 120th and Broadway (120 S)
        </div>
        <div id="shuttle-lines"></div>
        <div class="small" id="shuttle-updated"></div>
      </div>
    </div>

    <script>
      const REFRESH_MS = 30000; // 30 seconds

      async function loadSubway() {
        try {
          const res = await fetch("/api/subway");
          const data = await res.json();
          const container = document.getElementById("subway-lines");
          container.innerHTML = "";

          (data.trains || []).forEach((t) => {
            const line = document.createElement("div");
            line.className = "line";

            const dest = document.createElement("div");
            dest.className = "line-dest";

            const bullet = document.createElement("span");
            bullet.className = "bullet route-1";
            bullet.textContent = "1";
            dest.appendChild(bullet);

            const destText = document.createElement("span");
            destText.textContent = t.destination;
            dest.appendChild(destText);

            const times = document.createElement("div");
            times.className = "line-times";
            const mins = (t.departures || [])
              .map((d) => `${d.inMinutes} min`)
              .join("   ");
            times.textContent = mins;

            line.appendChild(dest);
            line.appendChild(times);
            container.appendChild(line);
          });

          document.getElementById(
            "subway-updated"
          ).textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        } catch (e) {
          console.error(e);
        }
      }

      async function loadShuttle() {
        try {
          const res = await fetch("/api/shuttle");
          const data = await res.json();
          const container = document.getElementById("shuttle-lines");
          container.innerHTML = "";

          const stops = [
            { key: "ecS", label: "La Salle/Tiemann Pl (EC S)" },
            { key: "s120", label: "120th and Broadway (120 S)" }
          ];

          const colorOrder = [
            { key: "blue", label: "Blue" },
            { key: "green", label: "Green" },
            { key: "red", label: "Red" }
          ];

          function addRowsForStop(stopData, stopLabel) {
            if (!stopData) return;
            colorOrder.forEach((color) => {
              const trips = stopData[color.key] || [];
              if (!trips.length) return;

              const line = document.createElement("div");
              line.className = "line";

              const left = document.createElement("div");
              left.className = "line-dest";
              left.textContent = stopLabel;

              const pill = document.createElement("span");
              pill.className = "pill " + color.key;
              pill.textContent = color.label;
              left.appendChild(pill);

              const right = document.createElement("div");
              right.className = "line-times";
              right.innerHTML = trips
                .map((t) => {
                  const cls = t.delayed ? "time-delayed" : "time-good";
                  if (t.direct) {
                    return `<span class="${cls}">${t.time} (direct)</span>`;
                  } else {
                    return `<span class="${cls}">${t.time} (walk → 96th)</span>`;
                  }
                })
                .join("   ");

              line.appendChild(left);
              line.appendChild(right);
              container.appendChild(line);
            });
          }

          stops.forEach((s) => {
            addRowsForStop(data[s.key], s.label);
          });

          document.getElementById(
            "shuttle-updated"
          ).textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        } catch (e) {
          console.error(e);
        }
      }

      function refreshAll() {
        loadSubway();
        loadShuttle();
      }

      refreshAll();
      setInterval(refreshAll, REFRESH_MS);
    </script>
  </body>
</html>
